import React, { useState, useEffect, useRef } from 'react';
import * as THREE from 'three';
import { 
  Droplets, 
  RotateCw, 
  Menu,
  X,
  Droplet,
  HandMetal,
  Waves,
  Touchpad,
  AlertTriangle,
  Recycle,
  Maximize2,
  Mail,
  Phone,
  MapPin,
  Send,
  Timer,
  ShoppingBag,
  ChevronRight,
  ShieldCheck
} from 'lucide-react';

const Sprinklo3DModel = ({ rotationAngle, isPressed }) => {
  const mountRef = useRef(null);
  const particleDataRef = useRef([]);

  useEffect(() => {
    if (!mountRef.current) return;

    const width = mountRef.current.clientWidth;
    const height = mountRef.current.clientHeight;

    // --- Scene Setup ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf8fafc); 
    const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
    camera.position.set(0, 1.5, 7.5); 
    camera.lookAt(0, 0, 0);

    // Optimized Renderer
    const renderer = new THREE.WebGLRenderer({ 
      antialias: true, 
      alpha: true, 
      powerPreference: "high-performance",
      precision: "mediump" 
    });
    renderer.setSize(width, height);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    mountRef.current.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
    directionalLight.position.set(5, 10, 7.5);
    scene.add(directionalLight);

    const sprinklo = new THREE.Group();

    // Reusable Materials
    const materials = {
      base: new THREE.MeshStandardMaterial({ color: 0x1e293b, roughness: 0.8 }),
      silicone: new THREE.MeshStandardMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.8 }),
      top: new THREE.MeshStandardMaterial({ color: 0xf1f5f9, roughness: 0.2 }),
      hole: new THREE.MeshBasicMaterial({ color: 0x0f172a }),
      water: new THREE.MeshBasicMaterial({ color: 0x60a5fa })
    };

    // Base Construction
    const base = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.3, 1, 24), materials.base);
    base.position.y = -0.5;
    sprinklo.add(base);

    const silicone = new THREE.Mesh(new THREE.CylinderGeometry(1.18, 1.18, 0.15, 24), materials.silicone);
    silicone.position.y = 0.05;
    sprinklo.add(silicone);

    const topGroup = new THREE.Group();
    const topMesh = new THREE.Mesh(new THREE.CylinderGeometry(1.1, 1.1, 0.8, 24), materials.top);
    topGroup.add(topMesh);

    // Holes
    const holePositions = [
      new THREE.Vector3(0.4, 0.401, 0.4), new THREE.Vector3(-0.4, 0.401, 0.4),
      new THREE.Vector3(0.4, 0.401, -0.4), new THREE.Vector3(-0.4, 0.401, -0.4),
      new THREE.Vector3(0.6, 0.401, 0), new THREE.Vector3(-0.6, 0.401, 0),
      new THREE.Vector3(0, 0.401, 0.6), new THREE.Vector3(0, 0.401, -0.6),
      new THREE.Vector3(0, 0.401, 0)
    ];
    const holeGeo = new THREE.CircleGeometry(0.12, 8);
    holePositions.forEach((pos) => {
      const hole = new THREE.Mesh(holeGeo, materials.hole);
      hole.rotation.x = -Math.PI / 2;
      hole.position.copy(pos);
      topGroup.add(hole);
    });
    sprinklo.add(topGroup);
    scene.add(sprinklo);

    // --- INSTANCED MESH OPTIMIZATION ---
    const particleCount = 200;
    const dummy = new THREE.Object3D();
    const instancedMesh = new THREE.InstancedMesh(
      new THREE.SphereGeometry(0.045, 4, 4), 
      materials.water, 
      particleCount
    );
    instancedMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
    scene.add(instancedMesh);

    // Initialize particle data state 
    const particles = [];
    for (let i = 0; i < particleCount; i++) {
      particles.push({
        position: new THREE.Vector3(0, -100, 0), 
        velocity: new THREE.Vector3(),
        active: false,
        life: 0
      });
    }
    particleDataRef.current = particles;

    // Interaction
    let isDragging = false;
    let prevX = 0, prevY = 0;
    const onStart = (x, y) => { isDragging = true; prevX = x; prevY = y; };
    const onMove = (x, y) => {
      if (!isDragging) return;
      sprinklo.rotation.y += (x - prevX) * 0.01;
      sprinklo.rotation.x += (y - prevY) * 0.01;
      prevX = x; prevY = y;
    };
    const onEnd = () => { isDragging = false; };

    mountRef.current.addEventListener('mousedown', e => onStart(e.clientX, e.clientY));
    window.addEventListener('mousemove', e => onMove(e.clientX, e.clientY));
    window.addEventListener('mouseup', onEnd);
    mountRef.current.addEventListener('touchstart', e => onStart(e.touches[0].clientX, e.touches[0].clientY), {passive: false});
    window.addEventListener('touchmove', e => onMove(e.touches[0].clientX, e.touches[0].clientY), {passive: false});
    window.addEventListener('touchend', onEnd);

    // Reusables
    const capUp = new THREE.Vector3();
    const tempVec = new THREE.Vector3();
    const gravity = new THREE.Vector3(0, -0.018, 0);

    const animate = () => {
      requestAnimationFrame(animate);

      // Model updates
      topGroup.rotation.y = THREE.MathUtils.lerp(topGroup.rotation.y, (rotationAngle * Math.PI) / 180, 0.15);
      topGroup.position.y = THREE.MathUtils.lerp(topGroup.position.y, isPressed ? -0.15 : 0, 0.2);

      // Physics State
      capUp.set(0, 1, 0).applyQuaternion(sprinklo.quaternion);
      const isUpsideDown = capUp.y < -0.5;
      const isAligned = Math.abs(rotationAngle % 90) < 10 || Math.abs(rotationAngle % 90) > 80;

      let spawnMode = 'NONE';
      if (isUpsideDown) {
        if (isPressed) spawnMode = 'RING';
        else if (isAligned) spawnMode = 'HOLES';
      }

      // Update Particles
      let spawnRate = 3;
      let spawned = 0;

      for (let i = 0; i < particleCount; i++) {
        const p = particles[i];

        if (p.active) {
          p.velocity.add(gravity);
          p.position.add(p.velocity);
          p.life--;
          
          if (p.life <= 0 || p.position.y < -8) {
            p.active = false;
            p.position.set(0, -100, 0); // Hide
          }
        } else if (spawnMode !== 'NONE' && spawned < spawnRate) {
          p.active = true;
          p.life = 60 + Math.random() * 20;
          spawned++;

          if (spawnMode === 'RING') {
            const angle = Math.random() * Math.PI * 2;
            const radius = 1.15;
            tempVec.set(Math.cos(angle) * radius, 0.1, Math.sin(angle) * radius);
            tempVec.applyMatrix4(sprinklo.matrixWorld);
            p.position.copy(tempVec);
            p.velocity.copy(capUp).multiplyScalar(0.15).addScalar((Math.random()-0.5)*0.02);
          } else {
            const holeIdx = Math.floor(Math.random() * holePositions.length);
            tempVec.copy(holePositions[holeIdx]);
            tempVec.y = 0.5;
            tempVec.applyMatrix4(topGroup.matrixWorld);
            p.position.copy(tempVec);
            p.velocity.copy(capUp).multiplyScalar(0.12);
          }
        }

        // Update Instance Matrix
        dummy.position.copy(p.position);
        dummy.updateMatrix();
        instancedMesh.setMatrixAt(i, dummy.matrix);
      }
      instancedMesh.instanceMatrix.needsUpdate = true;
      renderer.render(scene, camera);
    };
    animate();

    return () => {
      if (mountRef.current && renderer.domElement) mountRef.current.removeChild(renderer.domElement);
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('touchmove', onMove);
      window.removeEventListener('mouseup', onEnd);
      window.removeEventListener('touchend', onEnd);
    };
  }, [rotationAngle, isPressed]);

  return <div ref={mountRef} className="w-full h-full cursor-move" />;
};

const App = () => {
  const [rotation, setRotation] = useState(0);
  const [isPressed, setIsPressed] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  const togglePush = () => setIsPressed(!isPressed);
  const cycleAlignment = () => setRotation(prev => prev + 90);

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900 overflow-x-hidden selection:bg-blue-100 selection:text-blue-900">
      <nav className="fixed w-full bg-white/95 backdrop-blur-md z-50 border-b border-slate-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16 md:h-20 items-center">
            <div className="flex items-center gap-2">
              <div className="bg-blue-600 p-1.5 md:p-2 rounded-xl text-white shadow-lg">
                <Droplets size={20} className="md:w-6 md:h-6" />
              </div>
              <span className="text-xl md:text-2xl font-black tracking-tighter text-slate-900">SPRINKLO</span>
            </div>
            
            <div className="hidden md:flex items-center gap-10 text-sm font-bold uppercase tracking-widest text-slate-500">
              <a href="#how-it-works" className="hover:text-blue-600 transition-colors">Mechanism</a>
              <a href="#preorder" className="hover:text-blue-600 transition-colors">Pre-order</a>
              <a href="#contact" className="hover:text-blue-600 transition-colors">Contact</a>
              <button className="bg-slate-900 text-white px-8 py-3 rounded-2xl hover:bg-blue-600 transition-all shadow-xl shadow-slate-200 font-bold tracking-tight">
                Pre-order Yours — ₹299
              </button>
            </div>

            <div className="md:hidden">
              <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="p-2 text-slate-600">
                {isMenuOpen ? <X size={24} /> : <Menu size={24} />}
              </button>
            </div>
          </div>
        </div>
        
        {isMenuOpen && (
          <div className="md:hidden bg-white border-b border-slate-200 p-4 space-y-4 animate-in slide-in-from-top duration-300">
            <a href="#how-it-works" className="block text-lg font-bold text-slate-700" onClick={() => setIsMenuOpen(false)}>Mechanism</a>
            <a href="#preorder" className="block text-lg font-bold text-slate-700" onClick={() => setIsMenuOpen(false)}>Pre-order</a>
            <a href="#contact" className="block text-lg font-bold text-slate-700" onClick={() => setIsMenuOpen(false)}>Contact</a>
          </div>
        )}
      </nav>

      {/* Product Summary Hero */}
      <section className="pt-24 md:pt-36 pb-16 px-4">
        <div className="max-w-7xl mx-auto grid lg:grid-cols-2 gap-12 md:gap-20 items-center">
          <div className="space-y-10 order-2 lg:order-1">
            <div className="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-xs font-bold uppercase tracking-widest border border-blue-100">
              <Recycle size={14} className="animate-pulse" />
              Universal Mechanical Cap
            </div>
            
            <div className="space-y-6">
              <h1 className="text-5xl md:text-7xl font-black leading-[1.1] text-slate-900 tracking-tight">
                Sprinkle. Drink. <br />
                <span className="text-blue-600">Zero Damage.</span>
              </h1>
              <p className="text-lg md:text-xl text-slate-600 max-w-lg leading-relaxed font-medium">
                The all-in-one replacement cap. Rotate for a controlled spray, push for a full drink, and lock it tight for travel. Fits 95% of standard bottles.
              </p>
            </div>
            
            <div className="flex flex-col sm:flex-row gap-4 pt-4 items-start">
              <div className="p-8 bg-white rounded-3xl border border-slate-200 shadow-2xl shadow-blue-50 inline-block">
                <span className="text-[10px] font-black text-slate-400 block mb-3 uppercase tracking-widest">Early Bird Offer</span>
                <div className="flex items-center gap-4">
                  <span className="text-6xl font-black text-slate-900 tracking-tighter">₹299</span>
                  <div className="flex flex-col gap-1">
                    <span className="text-sm text-slate-400 font-bold line-through decoration-slate-300">₹800</span>
                    <span className="px-2 py-1 bg-green-100 text-green-700 text-[10px] font-black rounded uppercase tracking-wide">Save 60%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="relative order-1 lg:order-2 flex flex-col gap-6">
             <div className="bg-white rounded-[40px] md:rounded-[56px] shadow-2xl shadow-blue-100/50 border border-slate-200 overflow-hidden h-[400px] md:h-[500px] relative">
               <div className="absolute top-6 right-6 z-10 px-4 py-2 bg-white/80 backdrop-blur-md rounded-full border border-slate-200 flex items-center gap-2 shadow-sm">
                 <Maximize2 size={12} className="text-blue-600" />
                 <span className="text-[10px] font-bold text-slate-600 uppercase tracking-widest">Interactive Stage</span>
               </div>
               <Sprinklo3DModel rotationAngle={rotation} isPressed={isPressed} />
               <div className="absolute bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-3 bg-white/90 backdrop-blur-md px-5 py-2.5 rounded-full border border-slate-100 shadow-lg pointer-events-none">
                 <Touchpad size={16} className="text-blue-600" />
                 <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest">Tilt upside down to flow</span>
               </div>
             </div>

             <div className="flex justify-center items-center gap-4 py-4 px-6 bg-white border border-slate-200 rounded-3xl shadow-xl shadow-slate-100 self-center md:self-start">
                <button 
                  onClick={cycleAlignment} 
                  className="p-4 bg-slate-50 border border-slate-100 rounded-2xl shadow-sm hover:bg-blue-600 hover:text-white transition-all group flex items-center gap-3"
                  title="Rotate Hole Alignment"
                >
                  <RotateCw size={20} className="group-hover:rotate-180 transition-transform duration-500" />
                  <div className="text-left">
                    <span className="text-[10px] font-black uppercase tracking-widest block leading-none">Rotate Holes</span>
                    <span className="text-[9px] font-bold text-slate-400 group-hover:text-blue-100">Toggle Sprinkle</span>
                  </div>
                </button>
                <div className="w-[1px] h-10 bg-slate-200"></div>
                <button 
                  onClick={togglePush} 
                  className={`p-4 border border-slate-100 rounded-2xl shadow-sm transition-all group flex items-center gap-3 ${isPressed ? 'bg-blue-600 text-white shadow-blue-200' : 'bg-slate-50 text-slate-900 hover:bg-slate-100'}`}
                  title="Toggle Push Mode (Mechanical Drink)"
                >
                  <HandMetal size={20} className={isPressed ? 'animate-bounce' : ''} />
                  <div className="text-left">
                    <span className="text-[10px] font-black uppercase tracking-widest block leading-none">Push Mode</span>
                    <span className={`text-[9px] font-bold ${isPressed ? 'text-blue-100' : 'text-slate-400'}`}>
                      {isPressed ? 'Ring Flow Active' : 'Standard Flow'}
                    </span>
                  </div>
                </button>
             </div>
          </div>
        </div>
      </section>

      <section id="how-it-works" className="py-24 bg-white relative">
        <div className="absolute top-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-slate-200 to-transparent"></div>
        <div className="max-w-7xl mx-auto px-4">
          <div className="grid md:grid-cols-2 gap-20 items-center">
            <div className="space-y-12">
              <h2 className="text-5xl font-black text-slate-900 tracking-tight">3-Layer <br /><span className="text-blue-600">Mechanical Logic</span></h2>
              <div className="space-y-10">
                {[
                    { n: "01", t: "Top Structural Layer", d: "Industrial-grade head that rotates to adjust hole alignment." },
                    { n: "02", t: "Medical Silicone Barrier", d: "A flexible heart that ensures a liquid-tight seal during transport." },
                    { n: "03", t: "Inner Mechanical Control", d: "Aligns ports for Spray Mode or shuts them completely for travel." }
                ].map((step, i) => (
                    <div key={i} className="flex gap-6 group">
                        <div className="w-14 h-14 bg-slate-50 border border-slate-100 text-blue-600 rounded-2xl flex items-center justify-center font-black text-xl shrink-0 group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">{step.n}</div>
                        <div>
                            <h4 className="text-xl font-bold mb-2 text-slate-900">{step.t}</h4>
                            <p className="text-slate-500 text-sm font-medium leading-relaxed">{step.d}</p>
                        </div>
                    </div>
                ))}
              </div>
            </div>
            <div className="bg-slate-50 p-10 md:p-16 rounded-[48px] border border-slate-200 shadow-inner">
               <div className="space-y-12">
                  <div className="flex items-start gap-6">
                    <div className="p-4 bg-white rounded-2xl shadow-sm text-blue-600 border border-slate-100"><HandMetal size={32} /></div>
                    <div>
                      <h4 className="text-2xl font-black mb-2 uppercase tracking-tight text-slate-900">Push to Drink</h4>
                      <p className="text-slate-500 text-sm leading-relaxed font-medium">Bypass the sprinkle ports. The push mechanism shifts flow to the outer blue ring for normal hydration.</p>
                    </div>
                  </div>
                  <div className="flex items-start gap-6">
                    <div className="p-4 bg-white rounded-2xl shadow-sm text-blue-600 border border-slate-100"><Waves size={32} /></div>
                    <div>
                      <h4 className="text-2xl font-black mb-2 uppercase tracking-tight text-slate-900">Gravity Spray</h4>
                      <p className="text-slate-500 text-sm leading-relaxed font-medium">Rotate to align ports and invert the bottle to enjoy a controlled sprinkle effect via the top holes.</p>
                    </div>
                  </div>
               </div>
            </div>
          </div>
        </div>
      </section>

      {/* Professional Blue Pre-order Section */}
      <section id="preorder" className="py-24 bg-gradient-to-br from-slate-900 to-blue-900 text-white relative overflow-hidden">
        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
        <div className="absolute top-0 right-0 w-96 h-96 bg-blue-500/20 rounded-full blur-3xl -mr-48 -mt-48 pointer-events-none"></div>
        
        <div className="max-w-4xl mx-auto text-center relative z-10 px-4">
          <div className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600/20 text-blue-300 border border-blue-500/30 rounded-full text-xs font-black uppercase tracking-widest mb-8 backdrop-blur-sm">
            <Timer size={14} className="animate-pulse" />
            Limited Time Offer
          </div>
          <h2 className="text-5xl md:text-7xl font-black mb-8 tracking-tighter">Pre-order Yours Today.</h2>
          <p className="text-xl text-blue-100 font-medium mb-10 max-w-2xl mx-auto leading-relaxed">Be the first to experience Sprinklo. Lock in the early bird price of ₹299 before we hit retail shelves.</p>
          
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <button className="px-10 py-5 bg-white text-blue-900 rounded-2xl font-black text-lg hover:bg-blue-50 transition-all shadow-xl hover:scale-105 flex items-center justify-center gap-3">
              <ShoppingBag size={20} /> Pre-order Yours — ₹299
            </button>
            <button className="px-10 py-5 bg-transparent border border-blue-400 text-white rounded-2xl font-bold text-lg hover:bg-blue-800/50 transition-all flex items-center justify-center gap-2">
              Bulk Order Info <ChevronRight size={20} />
            </button>
          </div>
          <div className="mt-8 flex items-center justify-center gap-6 text-xs font-bold text-blue-300 uppercase tracking-widest">
            <span className="flex items-center gap-2"><ShieldCheck size={14} /> 1 Year Warranty</span>
            <span className="w-1 h-1 bg-blue-500 rounded-full"></span>
            <span>Ships Worldwide</span>
          </div>
        </div>
      </section>

      {/* Contact Us Section */}
      <section id="contact" className="py-24 bg-slate-50 border-t border-slate-200">
        <div className="max-w-7xl mx-auto px-4 grid lg:grid-cols-2 gap-16">
          <div className="space-y-8">
            <h2 className="text-5xl font-black tracking-tighter text-slate-900">Get in <span className="text-blue-600">Touch.</span></h2>
            <p className="text-slate-600 text-lg font-medium max-w-md">Questions about bulk orders or technology licensing? Reach out directly to our engineering team.</p>
            <div className="space-y-6">
              <div className="flex items-center gap-4 text-slate-600">
                <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-sm text-blue-600 border border-slate-100"><Mail size={20} /></div>
                <span className="font-bold">hello@sprinklo.in</span>
              </div>
              <div className="flex items-center gap-4 text-slate-600">
                <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-sm text-blue-600 border border-slate-100"><Phone size={20} /></div>
                <span className="font-bold">+91 98765 43210</span>
              </div>
              <div className="flex items-center gap-4 text-slate-600">
                <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-sm text-blue-600 border border-slate-100"><MapPin size={20} /></div>
                <span className="font-bold">Mumbai Innovation Lab, India</span>
              </div>
            </div>
          </div>
          <form className="bg-white p-10 rounded-[40px] shadow-xl border border-slate-100 space-y-6">
            <div className="grid grid-cols-2 gap-6">
              <input type="text" className="bg-slate-50 rounded-2xl px-6 py-4 outline-none font-medium text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Name" />
              <input type="email" className="bg-slate-50 rounded-2xl px-6 py-4 outline-none font-medium text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Email" />
            </div>
            <textarea rows="4" className="w-full bg-slate-50 rounded-2xl px-6 py-4 outline-none font-medium text-slate-900 placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Your Message..."></textarea>
            <button className="w-full bg-blue-600 text-white py-5 rounded-3xl font-black uppercase tracking-widest flex items-center justify-center gap-3 hover:bg-blue-700 transition-all shadow-lg shadow-blue-100">
              Send Message <Send size={20} />
            </button>
          </form>
        </div>
      </section>

      <footer className="py-16 bg-slate-900 text-white px-4">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-12">
          <div className="text-center md:text-left">
            <div className="flex items-center gap-3 justify-center md:justify-start mb-4">
              <Droplets className="text-blue-500" />
              <span className="text-3xl font-black tracking-tighter text-white">SPRINKLO.</span>
            </div>
            <p className="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">Mechanical Innovation</p>
          </div>
          <div className="flex flex-col items-center md:items-end">
            <div className="text-blue-400 font-black text-4xl">₹299</div>
            <p className="text-slate-500 text-[10px] font-black uppercase tracking-widest mt-1">Free Delivery across India</p>
          </div>
        </div>
        <div className="max-w-7xl mx-auto mt-12 pt-8 border-t border-slate-800 text-center text-slate-600 text-[10px] font-bold uppercase tracking-widest uppercase">
          © 2024 Sprinklo Lab.
        </div>
      </footer>
    </div>
  );
};

export default App;
